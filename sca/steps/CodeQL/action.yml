# CodeQL Static Analysis Action
#
# This composite action performs CodeQL static code analysis on the repository.
# It initializes CodeQL, attempts to auto-build the project (for compiled languages),
# and then analyzes the codebase for security vulnerabilities and code quality issues.
#
# Features:
# - Configurable CodeQL configuration file
# - Optional upload of findings to GitHub Code Scanning
# - Support for compiled languages via auto-build
# - Continues workflow even if build fails
#
# Usage:
#   - name: Run CodeQL Analysis
#     uses: ministryofjustice/devsecops-actions/sca/steps/CodeQL@main
#     with:
#       token: ${{ secrets.GITHUB_TOKEN }}
#       codeql-config-file: .github/codeql-config.yml  # Optional
#       codeql-upload-findings: always  # Optional: always, never, or on-fail
#
# Inputs:
#   codeql-config-file:
#     Optional path to a CodeQL configuration file for customizing analysis.
#     Default: "" (uses default CodeQL configuration)
#
#   codeql-upload-findings:
#     Controls when to upload SARIF results to GitHub Code Scanning.
#     Set to "never" if default CodeQL setup is already enabled on the repository.
#     Default: "always"
#     Options: always, never, on-fail
#
#   token:
#     GitHub token with required permissions:
#     - contents: read/write
#     - pull-requests: read/write
#     - issues: read/write
#     - security-events: read
#     Required: true
#
# Notes:
# - The autobuild step continues on error to allow analysis of partial builds
# - All CodeQL actions are pinned to specific SHA for security
# - Compatible with CodeQL's default setup and advanced configuration

name: ⚙️ CodeQL
description: CodeQL scan
author: Ministry of Justice UK

inputs:
  codeql-config-file:
    required: false
    description: "CodeQL configuration file path."
    default: ""

  codeql-upload-findings:
    required: false
    description: "Upload the findings from CodeQL as SARIF file to Code Scanning, set to never if default setup is enabled."
    default: "always"

  token:
    required: true
    description: "GitHub repostiroy token with read and write privileges to contents, pull request, issues and read only perimission to security events."

runs:
  using: composite
  steps:
    # Sets up CodeQL for analysis
    - name: Initialise
      uses: github/codeql-action/init@5d4e8d1aca955e8d8589aabd499c5cae939e33c7 # v4.31.9
      with:
        config-file: ${{ inputs.codeql-config-file }}

      # Auto-build for compiled languages
    - name: Build
      uses: github/codeql-action/autobuild@5d4e8d1aca955e8d8589aabd499c5cae939e33c7 # v4.31.9
      continue-on-error: true

    # Finalizes the CodeQL database, runs the analysis, and uploads the results to Code Scanning
    - name: Analyse
      uses: github/codeql-action/analyze@5d4e8d1aca955e8d8589aabd499c5cae939e33c7 # v4.31.9
      with:
        upload: ${{ inputs.codeql-upload-findings }}
