# Software Composition Analysis (SCA) GitHub Action
#
# This composite action performs comprehensive security scanning and dependency management for repositories.
#
# Features:
# - Dependency review and vulnerability detection
# - OWASP Dependency Check for known CVEs
# - Renovate bot for automated dependency updates
# - Secret scanning with Trufflehog
# - CodeQL static analysis
# - OpenSSF Scorecard security posture assessment
#
# Inputs:
#   score: (optional, default: "true")
#     Enable/disable OpenSSF Scorecard checks
#
#   renovate: (optional, default: "true")
#     Enable/disable Renovate bot execution for dependency updates
#
#   renovate-version: (optional, default: "42.64.1")
#     Specific version of Renovate CLI to use
#
#   dependency-review-config-file: (optional, default: "")
#     Path to custom configuration file for GitHub dependency review
#
#   trufflehog-config-file: (optional, default: "")
#     Path to custom Trufflehog configuration file
#
#   codeql-config-file: (optional, default: "")
#     Path to custom CodeQL configuration file
#
#   codeql-upload-findings: (optional, default: "always")
#     Controls SARIF upload behavior; set to "never" if default CodeQL setup is enabled
#
#   token: (required)
#     GitHub token with permissions:
#       - contents: read/write
#       - pull_requests: read/write
#       - issues: read/write
#       - security_events: read
#
# Usage:
#   - uses: ministryofjustice/devsecops-actions/sca@main
#     with:
#       token: ${{ secrets.GITHUB_TOKEN }}
#       score: "true"
#       renovate: "true"
#
# Outputs:
#   - OWASP Dependency Check SARIF report uploaded to Code Scanning
#   - Trufflehog findings artifact (30-day retention)
#   - CodeQL analysis results uploaded to Code Scanning
#   - OpenSSF Scorecard results uploaded to Code Scanning
#
# Security Thresholds:
#   - OWASP Dependency Check fails on CVSS score >= 7
#   - Trufflehog fails on scan errors
#
# Notes:
#   - All container images and actions are pinned to specific SHAs for security
#   - Renovate autodiscovery is disabled; only scans specified repository
#   - CodeQL autobuild continues on error to handle diverse project structures

name: Ministry of Justice UK - SCA âš¡ï¸
description: Software composition analysis GitHub action for dependency management, secret scanning, and security vulnerability detection
author: Ministry of Justice UK

inputs:
  score:
    required: false
    description: "Flag to execute OSSF checks"
    default: "true"

  renovate:
    required: false
    description: "Flag to evaluation Renovate execution"
    default: "true"

  renovate-version:
    required: false
    description: "Renovate CLI version, an optional argument which defaults to v42.64.1."
    default: "42.64.1"

  dependency-review-config-file:
    required: false
    description: "GitHub Actions dependency review configuration file path."
    default: ""

  trufflehog-config-file:
    required: false
    description: "Trufflehog configuration file path."
    default: ""

  codeql-config-file:
    required: false
    description: "CodeQL configuration file path."
    default: ""

  codeql-upload-findings:
    required: false
    description: "Upload the findings from CodeQL as SARIF file to Code Scanning, set to never if default setup is enabled."
    default: "always"

  token:
    required: true
    description: "GitHub repostiroy token with read and write privileges to contents, pull request, issues and read only perimission to security events."

runs:
  using: composite
  steps:
    - name: ğŸ“¦ Repository
      uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # frozen: v6.0.1

    - name: ğŸ“Š Dependencies
      uses: actions/dependency-review-action@774d14bf50b7a2e2460f9f49e25c52503ecab125 # frozen: v4.8.3
      with:
        config-file: ${{ inputs.dependency-review-config-file }}
        head-ref: ${{ github.head_ref || github.sha }}
        base-ref: ${{ github.base_ref || github.event.repository.default_branch }}

    - name: ğŸ” OWASP
      uses: dependency-check/Dependency-Check_Action@1e54355a8b4c8abaa8cc7d0b70aa655a3bb15a6c # frozen: v1.1.0
      with:
        project: ${{ github.repository }}
        path: "."
        format: JSON
        args: >
          --failOnCVSS 7
          --prettyPrint
          --format SARIF
          --out ./reports

    - name: ğŸ” OWASP
      if: always()
      uses: github/codeql-action/upload-sarif@5d4e8d1aca955e8d8589aabd499c5cae939e33c7 # frozen: v4.31.9
      with:
        sarif_file: ./reports/dependency-check-report.sarif

    - name: ğŸ” Renovate
      if: inputs.renovate == 'true'
      uses: renovatebot/github-action@8b7941943a108b2cc2150730963164aa8baeab8c # frozen: v44.2.2
      with:
        token: ${{ inputs.token }}
        renovate-version: ${{ inputs.renovate-version }}
      env:
        RENOVATE_AUTODISCOVER: "false"
        RENOVATE_REPOSITORIES: ${{ github.repository }}

    - name: ğŸ”‘ Secrets
      shell: bash
      run: docker run --rm
        \-e GIT_MODE=false
        \-v "$(pwd)":/src
        \ghcr.io/ministryofjustice/devsecops-hooks:v1.3.0 # https://github.com/ministryofjustice/devsecops-hooks

    # Initiate scan
    - name: ğŸ· Trufflehog
      shell: bash
      run: |
        CONFIG=""

        if [ -n "${{ inputs.trufflehog-config-file }}" ]; then
          CONFIG="--config ${{ inputs.trufflehog-config-file }}"
        fi

        docker run --rm \
        -v "$(pwd)":/src trufflesecurity/trufflehog:3.92.4@sha256:c28ab4a11e01d6fcc10776f65cce015bdf9795f2393cffa2ec0a7c8464ee58b6 \
        git https://github.com/${{ github.repository }} \
        $CONFIG \
        --concurrency=14 \
        --no-verification \
        --no-update \
        --branch ${{ github.head_ref }} \
        --fail-on-scan-errors \
        --json > trufflehog.json

    # Upload findings
    - name: ğŸ· Trufflehog
      if: always()
      uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # frozen: v6.0.0
      with:
        name: ğŸ· TruffleHog
        path: trufflehog.json
        retention-days: 30

      # Sets up CodeQL for analysis
    - name: âš™ï¸ CodeQL
      uses: github/codeql-action/init@5d4e8d1aca955e8d8589aabd499c5cae939e33c7 # frozen: v4.31.9
      with:
        config-file: ${{ inputs.codeql-config-file }}

      # Auto-build for compiled languages
    - name: âš™ï¸ CodeQL
      uses: github/codeql-action/autobuild@5d4e8d1aca955e8d8589aabd499c5cae939e33c7 # frozen: v4.31.9
      continue-on-error: true

    # Finalizes the CodeQL database, runs the analysis, and uploads the results to Code Scanning
    - name: âš™ï¸ CodeQL
      uses: github/codeql-action/analyze@5d4e8d1aca955e8d8589aabd499c5cae939e33c7 # frozen: v4.31.9
      with:
        upload: ${{ inputs.codeql-upload-findings }}

    - name: ğŸ›¡ OpenSSF
      if: inputs.score == 'true'
      uses: ossf/scorecard-action@4eaacf0543bb3f2c246792bd56e8cdeffafb205a # frozen: v2.4.3
      with:
        results_file: ossf.sarif
        results_format: sarif
        repo_token: ${{ inputs.token }}
        publish_results: true

    - name: ğŸ›¡ OpenSSF
      if: inputs.score == 'true'
      uses: github/codeql-action/upload-sarif@5d4e8d1aca955e8d8589aabd499c5cae939e33c7 # frozen: v4.31.9
      with:
        sarif_file: ossf.sarif
