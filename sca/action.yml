# Ministry of Justice UK - Software Composition Analysis (SCA) Action
#
# A comprehensive GitHub composite action that performs software composition analysis
# including dependency management, secret scanning, and security vulnerability detection.
#
# Features:
# - ğŸ“¦ Repository checkout and setup
# - ğŸ“Š Dependency review and analysis
# - ğŸ” OWASP dependency vulnerability scanning
# - ğŸ” Renovate automated dependency updates (optional)
# - ğŸ”‘ Secret scanning
# - ğŸ· Trufflehog secret detection
# - âš™ï¸ CodeQL security analysis
# - ğŸ›¡ OpenSSF Scorecard security assessment
# - ğŸ“‹ SBOM (Software Bill of Materials) generation
#
# Usage:
#   - uses: ministryofjustice/devsecops-actions/sca@main
#     with:
#       token: ${{ secrets.GITHUB_TOKEN }}
#       renovate: 'true'
#       renovate-version: '42.64.1'
#       dependency-review-config-file: '.github/dependency-review-config.yml'
#       trufflehog-config-file: '.github/trufflehog-config.yml'
#       codeql-config-file: '.github/codeql-config.yml'
#       codeql-upload-findings: 'always'
#
# Required Permissions:
#   The provided token must have:
#   - contents: read/write
#   - pull-requests: read/write
#   - issues: read/write
#   - security-events: read
#
# Inputs:
#   renovate: Enable/disable Renovate execution (default: 'true')
#   renovate-version: Renovate CLI version (default: '42.64.1')
#   dependency-review-config-file: Path to dependency review config (optional)
#   trufflehog-config-file: Path to Trufflehog config (optional)
#   codeql-config-file: Path to CodeQL config (optional)
#   codeql-upload-findings: Upload CodeQL SARIF findings (default: 'always', use 'never' if default setup enabled)
#   token: GitHub token with required permissions (required)

name: Ministry of Justice UK - SCA âš¡ï¸
description: Software composition analysis GitHub action for dependency management, secret scanning, and security vulnerability detection
author: Ministry of Justice UK

inputs:
  renovate:
    required: false
    description: "Flag to evaluation Renovate execution"
    default: "true"

  renovate-version:
    required: false
    description: "Renovate CLI version, an optional argument which defaults to v42.64.1."
    default: "42.64.1"

  dependency-review-config-file:
    required: false
    description: "GitHub Actions dependency review configuration file path."
    default: ""

  trufflehog-config-file:
    required: false
    description: "Trufflehog configuration file path."
    default: ""

  codeql-config-file:
    required: false
    description: "CodeQL configuration file path."
    default: ""

  codeql-upload-findings:
    required: false
    description: "Upload the findings from CodeQL as SARIF file to Code Scanning, set to never if default setup is enabled."
    default: "always"

  token:
    required: true
    description: "GitHub repostiroy token with read and write privileges to contents, pull request, issues and read only perimission to security events."

runs:
  using: composite
  steps:
    - name: ğŸ“¦ Repository
      uses: ./sca/steps/Repository

    - name: ğŸ“Š Dependencies
      uses: ./sca/steps/Dependencies
      with:
        dependency-review-config-file: ${{ inputs.dependency-review-config-file }}

    - name: ğŸ” OWASP
      uses: ./sca/steps/OWASP

    - name: ğŸ” Renovate
      if: inputs.renovate == 'true'
      uses: ./sca/steps/Renovate
      with:
        token: ${{ inputs.token }}
        renovate-version: ${{ inputs.renovate-version }}

    - name: ğŸ”‘ Secrets
      uses: ./sca/steps/Secrets

    - name: ğŸ· Trufflehog
      uses: ./sca/steps/Trufflehog
      with:
        trufflehog-config-file: ${{ inputs.trufflehog-config-file }}

    - name: âš™ï¸ CodeQL
      uses: ./sca/steps/CodeQL
      with:
        codeql-config-file: ${{ inputs.codeql-config-file }}
        codeql-upload-findings: ${{ inputs.codeql-upload-findings }}

    - name: ğŸ›¡ OpenSSF
      uses: ./sca/steps/OpenSSF
      with:
        token: ${{ inputs.token }}

    - name: ğŸ“‹ SBOM
      uses: ./sca/steps/SBOM
      with:
        token: ${{ inputs.token }}
