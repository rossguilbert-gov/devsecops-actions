# ==============================================================================
# CodeQL - Static Application Security Testing (SAST) Action
# ==============================================================================
#
# Copyright (c) Ministry of Justice UK
# SPDX-License-Identifier: MIT
#
# ==============================================================================
# DESCRIPTION
# ==============================================================================
# Performs advanced static application security testing (SAST) using GitHub's
# CodeQL analysis engine. Identifies security vulnerabilities, coding errors,
# and potential bugs through semantic code analysis. Supports multiple
# programming languages and provides actionable remediation guidance integrated
# with GitHub Code Scanning.
#
# ==============================================================================
# FEATURES
# ==============================================================================
# - Multi-language support: C/C++, C#, Go, Java, JavaScript/TypeScript, 
#   Python, Ruby, Swift, Kotlin
# - Semantic code analysis for deep vulnerability detection
# - Pre-built security queries for common vulnerability patterns
# - Custom query support for organisation-specific security policies
# - Automatic language detection and build system integration
# - SARIF report generation for GitHub Code Scanning
# - Integration with GitHub Advanced Security
#
# ==============================================================================
# USAGE
# ==============================================================================
# Basic usage (auto-detection):
#   - uses: ministryofjustice/devsecops-actions/sca/codeql@v1.3.0
#
# With custom configuration:
#   - uses: ministryofjustice/devsecops-actions/sca/codeql@v1.3.0
#     with:
#       codeql-config-file: ".github/codeql/codeql-config.yml"
#       codeql-upload-findings: "always"
#
# Disable upload (for default CodeQL setup):
#   - uses: ministryofjustice/devsecops-actions/sca/codeql@v1.3.0
#     with:
#       codeql-upload-findings: "never"
#
# ==============================================================================
# CONFIGURATION
# ==============================================================================
# Custom configuration file format (YAML):
#   name: "Custom CodeQL Config"
#   queries:
#     - uses: security-extended
#     - uses: security-and-quality
#   paths-ignore:
#     - "test/**"
#     - "docs/**"
#
# See: https://docs.github.com/en/code-security/code-scanning/creating-an-advanced-setup-for-code-scanning/customizing-your-advanced-setup-for-code-scanning
#
# ==============================================================================
# PREREQUISITES
# ==============================================================================
# - GitHub Advanced Security license (for private repositories)
# - Repository must have Code Scanning enabled
# - Supported programming language in the repository
#
# ==============================================================================
# TOOL INFORMATION
# ==============================================================================
# Tool: GitHub CodeQL
# Version: v4.31.9 (Action version)
# Documentation: https://codeql.github.com/docs/
#
# ==============================================================================
# VERSION INFORMATION
# ==============================================================================
# Action Version: 1.0.0
# Last Updated: 2026-01-15
#
# ==============================================================================

name: ⚙️ CodeQL
description: CodeQL scan
author: Ministry of Justice UK

inputs:
  codeql-config-file:
    required: false
    description: "Path to the CodeQL configuration file for customising code analysis queries and settings. Leave empty to use default settings."
    default: ""

  codeql-upload-findings:
    required: false
    description: "Controls whether CodeQL findings are uploaded as SARIF files to GitHub Code Scanning. Set to 'never' if default setup is enabled to avoid conflicts."
    default: "always"

  token:
    required: true
    description: "GitHub repository token with read and write permissions for contents, pull requests, and issues, plus read-only access to security events."

runs:
  using: composite
  steps:
    # Initialises CodeQL for analysis
    - name: Initialise
      uses: github/codeql-action/init@5d4e8d1aca955e8d8589aabd499c5cae939e33c7 # v4.31.9
      with:
        config-file: ${{ inputs.codeql-config-file }}

    # Automatically builds compiled languages
    - name: Build
      uses: github/codeql-action/autobuild@5d4e8d1aca955e8d8589aabd499c5cae939e33c7 # v4.31.9
      continue-on-error: true

    # Finalises the CodeQL database, runs the analysis, and uploads the results to Code Scanning
    - name: Analyse
      uses: github/codeql-action/analyze@5d4e8d1aca955e8d8589aabd499c5cae939e33c7 # v4.31.9
      with:
        upload: ${{ inputs.codeql-upload-findings }}
