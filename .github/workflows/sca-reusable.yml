# Software Composition Analysis (SCA) - Reusable Workflow
#
# Purpose:
#   Reusable workflow that runs SCA checks with OWASP and CodeQL parallelised
#   alongside the remaining sequential tools, reducing overall wall-clock time.
#
# Usage (from a consuming repo):
#   jobs:
#     sca:
#       uses: ministryofjustice/devsecops-actions/.github/workflows/sca-reusable.yml@<sha>
#       with:
#         dependency-review-config-file: "./.github/dependency-review-config.yml"
#         dependency-check-suppression-file: "dependency-check-suppression.xml"
#       secrets: inherit
#
# Jobs:
#   sca:
#     - Runs all tools except OWASP and CodeQL sequentially
#   owasp:
#     - Runs OWASP Dependency-Check in parallel
#   codeql:
#     - Runs CodeQL SAST in parallel
#
# Permissions required in the calling workflow job:
#   permissions:
#     contents: write
#     pull-requests: write
#     issues: write
#     security-events: write
#     actions: read

name: SCA Reusable ‚ö°Ô∏è

on:
  workflow_call:
    inputs:
      renovate:
        required: false
        type: string
        default: "true"
        description: "Enable or disable Renovate bot for automated dependency updates"

      node-version:
        required: false
        type: string
        default: "24.11.1"
        description: "Node.js version to use for SBOM generation and related tooling"

      renovate-version:
        required: false
        type: string
        default: "43.31.1"
        description: "Renovate CLI version to use for dependency scanning (specify without 'v' prefix)"

      dependency-review-config-file:
        required: false
        type: string
        default: ""
        description: "Path to custom dependency review configuration file"

      trufflehog-config-file:
        required: false
        type: string
        default: ""
        description: "Path to custom TruffleHog configuration file for secret scanning customisation"

      trufflehog-output-filename:
        required: false
        type: string
        default: "sca-trufflehog"
        description: "TruffleHog JSON output file name (.json extension will be appended automatically)"

      codeql-config-file:
        required: false
        type: string
        default: ""
        description: "Path to custom CodeQL configuration file for SAST query customisation"

      codeql-upload-findings:
        required: false
        type: string
        default: "always"
        description: "Control SARIF upload to Code Scanning. Set to 'never' if GitHub's default CodeQL setup is enabled"

      codeql-languages:
        required: false
        type: string
        default: ""
        description: "A comma-separated list of CodeQL languages to analyse"

      docker-images-file:
        required: false
        type: string
        default: ""
        description: "Path to JSON file containing 'images' array with Docker image URIs for container SBOM generation"

      output-directory-name:
        required: false
        type: string
        default: "reports"
        description: "Output directory path for generated reports and scan results"

      dependency-check-suppression-file:
        required: false
        type: string
        default: ""
        description: "The file path to the suppression XML file for OWASP Dependency-Check"

    secrets:
      token:
        required: true
        description: "GitHub repository token with permissions for contents, pull requests, issues, and security events"

jobs:
  sca:
    permissions:
      contents: write
      pull-requests: write
      issues: write
      security-events: write
      actions: read

    name: Execute ‚öôÔ∏è
    runs-on: ["ubuntu-latest"]

    steps:
      - name: Repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: ‚ö°Ô∏è SCA
        uses: ministryofjustice/devsecops-actions/sca@4cba938a5e1a31dc21c0f97e1cc7a9c02b81f1ee # sca-concurrency
        with:
          token: ${{ secrets.token }}
          renovate: ${{ inputs.renovate }}
          node-version: ${{ inputs.node-version }}
          renovate-version: ${{ inputs.renovate-version }}
          dependency-review-config-file: ${{ inputs.dependency-review-config-file }}
          trufflehog-config-file: ${{ inputs.trufflehog-config-file }}
          trufflehog-output-filename: ${{ inputs.trufflehog-output-filename }}
          docker-images-file: ${{ inputs.docker-images-file }}
          output-directory-name: ${{ inputs.output-directory-name }}
          run-owasp: "false"
          run-codeql: "false"

  owasp:
    permissions:
      contents: read
      security-events: write

    name: OWASP üîé
    runs-on: ["ubuntu-latest"]

    steps:
      - name: Repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: üîé OWASP
        uses: ministryofjustice/devsecops-actions/sca/owasp@4cba938a5e1a31dc21c0f97e1cc7a9c02b81f1ee # sca-concurrency
        with:
          output-directory-name: ${{ inputs.output-directory-name }}
          dependency-check-suppression-file: ${{ inputs.dependency-check-suppression-file }}

  codeql:
    permissions:
      contents: read
      security-events: write
      actions: read

    name: CodeQL ‚öôÔ∏è
    runs-on: ["ubuntu-latest"]

    steps:
      - name: Repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: ‚öôÔ∏è CodeQL
        uses: ministryofjustice/devsecops-actions/sca/codeql@4cba938a5e1a31dc21c0f97e1cc7a9c02b81f1ee # sca-concurrency
        with:
          codeql-languages: ${{ inputs.codeql-languages }}
          codeql-config-file: ${{ inputs.codeql-config-file }}
          codeql-upload-findings: ${{ inputs.codeql-upload-findings }}
